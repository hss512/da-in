<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <link type="text/css" rel="stylesheet" th:src="@{/css/chat.css}">
    <!--
        <script type="text/javascript" th:src="@{/js/chat.js}"></script>
    -->
</head>
<body>
<div class="container">
  <div class="col-6">
    <h1>[[${room.name}]]</h1>
  </div>
  <div>
    <div id="msgArea" class="col"></div>
    <div class="col-6">
      <div class="input-group mb-3">
        <input type="text" id="msg" class="form-control">
        <div class="input-group-append">
          <button class="btn btn-outline-secondary" type="button" onclick="sendMessage()" id="button-send">전송</button>
          <button class="btn btn-outline-secondary" type="button" onclick="disconnectChat()" id="button-leave">퇴장</button>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6"></div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script th:inline="javascript">
      var roomName = [[${room.name}]];
      var roomId = [[${room.roomCode}]];
      var username = [[${userDetails.getUsername()}]];

      console.log(typeof(username));
      var sockJs = new SockJS("/stomp/chat", null, {transports: ["websocket", "xhr-streaming", "xhr-polling"]});
      let stomp = Stomp.over(sockJs);
      function connectChat(){
        console.log(roomName + ", " + roomId + ", " + username);


          stomp.connect({}, function (){
          console.log("STOMP Connection")

          //4. subscribe(path, callback)으로 메세지를 받을 수 있음
          stomp.subscribe("/sub/chat/room/" + roomId, function (chat) {
            let content = JSON.parse(chat.body);
            var writer = content.writer;
            console.log(content);
            var message= content.message;
            let chatTime = content.chatTime;
            var chatTime2='';
            chatTime2+=chatTime.substring(6,7);
            chatTime2+="월 "
            chatTime2+=chatTime.substring(8,10);
            chatTime2+="일 "
            chatTime2+=chatTime.substring(11,13);
            chatTime2+="시 "
            chatTime2+=chatTime.substring(14,16);
            chatTime2+="분"
            var str = '';

            if(writer === username){
              str = "<div>";
              str += "<div id='writeByMe' style='color: blue'>";
              str += "<b>"+ "<span style='font-size:10px;'>"+ chatTime2 +"</span>"+ " "+ writer + " : " + message + "</b>";
              str += "</div></div>";
              $("#msgArea").append(str);
            }
            else{
              str = "<div>";
              str += "<div id='writeByYou' style='color: red'>";
              str += "<b>"+ "<span style='font-size:12px;'>"+ chatTime2 +"</span>"+ " "+ writer + " : " + message + "</b>";
              str += "</div></div>";
              $("#msgArea").append(str);
            }

          });
              stomp.subscribe('/sub/chat/leave/room/' + roomId, function (chat) {
                  let content = JSON.parse(chat.body);
                  var writer = content.writer;
                  console.log(content);
                  var message = content.message;
                  let chatTime = content.chatTime;
                  var chatTime2 = '';
                  chatTime2 += chatTime.substring(6, 7);
                  chatTime2 += "월 "
                  chatTime2 += chatTime.substring(8, 10);
                  chatTime2 += "일 "
                  chatTime2 += chatTime.substring(11, 13);
                  chatTime2 += "시 "
                  chatTime2 += chatTime.substring(14, 16);
                  chatTime2 += "분"
                  var str = '';


                  str = "<div>";
                  str += "<div style='color: black'>";
                  str += "<b>" + "<span style='font-size:12px;'>" + chatTime2 + "</span>" + " " + writer + " : " + message + "</b>";
                  str += "</div></div>";
                  $("#msgArea").append(str);
              })

          stomp.send('/pub/chat/enter/'+roomId, {}, JSON.stringify({roomId: roomId, writer: username}))
        });

      };
      function sendMessage(){
          var msg = document.getElementById("msg");
          console.log(username + ":" + msg.value);
          stomp.send('/pub/chat/message/'+roomId, {}, JSON.stringify({roomId: roomId, message: msg.value, writer: username}));
          msg.value = '';
      }
      document.addEventListener("keypress", function(e){
          if(e.keyCode == 13){ //enter press
              sendMessage();
          }
      });


      function unsubscribeStomp(content){
          stomp.unsubscribe(content);
      }

      function disconnectChat() {
          stomp.send('/pub/chat/leave/'+roomId,{},JSON.stringify({roomId:roomId,writer:username}));
          // unsubscribeStomp(content);
          stomp.disconnect();
          $.ajax({
              type:"get",
              url:"/api/chat/room/leave/"+roomId+"/exit",
              dataType:"json"
          })
              .done(res=>{
                  if(res===1){
                      console.log("유저수 1감소")
                  }else {
                      console.log("api실패");
                  }
              }).fail(err=>{
                  console.error(err);
          })
          location.href='/chat/rooms';

      }
      connectChat();
     </script>
</body>

</html>
